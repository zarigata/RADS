// ============================================================================
// RADS Web Engine - Pure HTML+CSS Task Manager
// Runs on http://localhost:5050
// ONLY uses RADS + HTML + CSS (no external JavaScript libraries)
// ============================================================================

// Initialize database
blast init_database() {
    db.open("tasks_webapp.db");
    db.execute("CREATE TABLE IF NOT EXISTS tasks (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        description TEXT NOT NULL,
        done INTEGER DEFAULT 0,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )");

    // Add sample data if empty
    db.execute("INSERT OR IGNORE INTO tasks (id, description, done) VALUES
        (1, 'Build RADS Web Engine', 1),
        (2, 'Create HTML+CSS task manager', 1),
        (3, 'Deploy to localhost:5050', 0),
        (4, 'Test all features', 0)
    ");

    echo("‚úì Database initialized: tasks_webapp.db");
}

// Home page - Main interface
blast page_home(path, method, body, query, params, headers, cookies) {
    turbo html = "<!DOCTYPE html>";
    html = html + "<html lang='en'><head>";
    html = html + "<meta charset='UTF-8'>";
    html = html + "<meta name='viewport' content='width=device-width, initial-scale=1.0'>";
    html = html + "<title>ü¶ã RADS Task Manager</title>";

    // ========== CSS STYLES ==========
    html = html + "<style>";
    html = html + "* { margin: 0; padding: 0; box-sizing: border-box; }";

    // Body and background
    html = html + "body {";
    html = html + "  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;";
    html = html + "  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);";
    html = html + "  min-height: 100vh;";
    html = html + "  padding: 20px;";
    html = html + "}";

    // Container
    html = html + ".container {";
    html = html + "  max-width: 900px;";
    html = html + "  margin: 0 auto;";
    html = html + "}";

    // Header
    html = html + ".header {";
    html = html + "  text-align: center;";
    html = html + "  color: white;";
    html = html + "  margin-bottom: 30px;";
    html = html + "  animation: fadeIn 0.6s ease-in;";
    html = html + "}";

    html = html + ".header h1 {";
    html = html + "  font-size: 3em;";
    html = html + "  margin-bottom: 10px;";
    html = html + "  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);";
    html = html + "}";

    html = html + ".header p {";
    html = html + "  font-size: 1.2em;";
    html = html + "  opacity: 0.9;";
    html = html + "}";

    // Card
    html = html + ".card {";
    html = html + "  background: white;";
    html = html + "  border-radius: 15px;";
    html = html + "  box-shadow: 0 20px 60px rgba(0,0,0,0.3);";
    html = html + "  padding: 30px;";
    html = html + "  margin-bottom: 20px;";
    html = html + "  animation: slideUp 0.6s ease-out;";
    html = html + "}";

    // Stats bar
    html = html + ".stats {";
    html = html + "  background: rgba(255,255,255,0.95);";
    html = html + "  border-radius: 10px;";
    html = html + "  padding: 20px;";
    html = html + "  margin-bottom: 20px;";
    html = html + "  display: flex;";
    html = html + "  justify-content: space-around;";
    html = html + "  box-shadow: 0 4px 15px rgba(0,0,0,0.1);";
    html = html + "}";

    html = html + ".stat-item {";
    html = html + "  text-align: center;";
    html = html + "}";

    html = html + ".stat-number {";
    html = html + "  font-size: 2em;";
    html = html + "  font-weight: bold;";
    html = html + "  color: #667eea;";
    html = html + "}";

    html = html + ".stat-label {";
    html = html + "  color: #666;";
    html = html + "  font-size: 0.9em;";
    html = html + "  margin-top: 5px;";
    html = html + "}";

    // Form
    html = html + ".add-form {";
    html = html + "  display: flex;";
    html = html + "  gap: 15px;";
    html = html + "  margin-bottom: 30px;";
    html = html + "}";

    html = html + ".add-form input {";
    html = html + "  flex: 1;";
    html = html + "  padding: 15px;";
    html = html + "  font-size: 16px;";
    html = html + "  border: 2px solid #e2e8f0;";
    html = html + "  border-radius: 10px;";
    html = html + "  transition: all 0.3s;";
    html = html + "}";

    html = html + ".add-form input:focus {";
    html = html + "  outline: none;";
    html = html + "  border-color: #667eea;";
    html = html + "  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);";
    html = html + "}";

    // Buttons
    html = html + ".btn {";
    html = html + "  padding: 15px 30px;";
    html = html + "  font-size: 16px;";
    html = html + "  font-weight: 600;";
    html = html + "  border: none;";
    html = html + "  border-radius: 10px;";
    html = html + "  cursor: pointer;";
    html = html + "  transition: all 0.3s;";
    html = html + "  text-decoration: none;";
    html = html + "  display: inline-block;";
    html = html + "}";

    html = html + ".btn:hover {";
    html = html + "  transform: translateY(-2px);";
    html = html + "  box-shadow: 0 4px 12px rgba(0,0,0,0.15);";
    html = html + "}";

    html = html + ".btn-primary {";
    html = html + "  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);";
    html = html + "  color: white;";
    html = html + "}";

    html = html + ".btn-success {";
    html = html + "  background: #48bb78;";
    html = html + "  color: white;";
    html = html + "  padding: 10px 20px;";
    html = html + "  font-size: 14px;";
    html = html + "}";

    html = html + ".btn-danger {";
    html = html + "  background: #f56565;";
    html = html + "  color: white;";
    html = html + "  padding: 10px 20px;";
    html = html + "  font-size: 14px;";
    html = html + "}";

    // Tasks
    html = html + ".tasks-section h2 {";
    html = html + "  color: #2d3748;";
    html = html + "  margin-bottom: 20px;";
    html = html + "  font-size: 1.8em;";
    html = html + "}";

    html = html + ".task {";
    html = html + "  background: #f7fafc;";
    html = html + "  padding: 20px;";
    html = html + "  margin-bottom: 15px;";
    html = html + "  border-radius: 10px;";
    html = html + "  border-left: 4px solid #667eea;";
    html = html + "  transition: all 0.3s;";
    html = html + "  animation: taskAppear 0.4s ease-out;";
    html = html + "}";

    html = html + ".task:hover {";
    html = html + "  transform: translateX(5px);";
    html = html + "  box-shadow: 0 4px 15px rgba(0,0,0,0.1);";
    html = html + "}";

    html = html + ".task.completed {";
    html = html + "  opacity: 0.7;";
    html = html + "  background: #e6fffa;";
    html = html + "  border-left-color: #48bb78;";
    html = html + "}";

    html = html + ".task.completed .task-text {";
    html = html + "  text-decoration: line-through;";
    html = html + "  color: #718096;";
    html = html + "}";

    html = html + ".task-text {";
    html = html + "  font-size: 18px;";
    html = html + "  margin-bottom: 12px;";
    html = html + "  font-weight: 500;";
    html = html + "  color: #2d3748;";
    html = html + "}";

    html = html + ".task-meta {";
    html = html + "  font-size: 12px;";
    html = html + "  color: #a0aec0;";
    html = html + "  margin-bottom: 12px;";
    html = html + "}";

    html = html + ".task-actions {";
    html = html + "  display: flex;";
    html = html + "  gap: 10px;";
    html = html + "}";

    html = html + ".task-actions form {";
    html = html + "  display: inline-block;";
    html = html + "}";

    html = html + ".empty-state {";
    html = html + "  text-align: center;";
    html = html + "  padding: 60px 20px;";
    html = html + "  color: #a0aec0;";
    html = html + "}";

    html = html + ".empty-state-icon {";
    html = html + "  font-size: 4em;";
    html = html + "  margin-bottom: 20px;";
    html = html + "}";

    // Footer
    html = html + ".footer {";
    html = html + "  text-align: center;";
    html = html + "  color: white;";
    html = html + "  margin-top: 40px;";
    html = html + "  opacity: 0.8;";
    html = html + "}";

    // Animations
    html = html + "@keyframes fadeIn {";
    html = html + "  from { opacity: 0; transform: translateY(-20px); }";
    html = html + "  to { opacity: 1; transform: translateY(0); }";
    html = html + "}";

    html = html + "@keyframes slideUp {";
    html = html + "  from { opacity: 0; transform: translateY(30px); }";
    html = html + "  to { opacity: 1; transform: translateY(0); }";
    html = html + "}";

    html = html + "@keyframes taskAppear {";
    html = html + "  from { opacity: 0; transform: scale(0.95); }";
    html = html + "  to { opacity: 1; transform: scale(1); }";
    html = html + "}";

    html = html + "</style>";
    html = html + "</head><body>";

    // ========== HTML CONTENT ==========
    html = html + "<div class='container'>";

    // Header
    html = html + "<div class='header'>";
    html = html + "<h1>ü¶ã RADS Task Manager</h1>";
    html = html + "<p>TURBO & RADICAL Task Management</p>";
    html = html + "</div>";

    // Stats (we'll use JavaScript to populate this, but for now static)
    html = html + "<div class='stats'>";
    html = html + "<div class='stat-item'>";
    html = html + "<div class='stat-number' id='total-tasks'>0</div>";
    html = html + "<div class='stat-label'>Total Tasks</div>";
    html = html + "</div>";
    html = html + "<div class='stat-item'>";
    html = html + "<div class='stat-number' id='completed-tasks'>0</div>";
    html = html + "<div class='stat-label'>Completed</div>";
    html = html + "</div>";
    html = html + "<div class='stat-item'>";
    html = html + "<div class='stat-number' id='pending-tasks'>0</div>";
    html = html + "<div class='stat-label'>Pending</div>";
    html = html + "</div>";
    html = html + "</div>";

    // Add Task Form
    html = html + "<div class='card'>";
    html = html + "<h2 style='margin-bottom: 20px; color: #2d3748;'>‚ûï Add New Task</h2>";
    html = html + "<form class='add-form' action='/add' method='POST'>";
    html = html + "<input type='text' name='description' placeholder='What needs to be done?' required autofocus>";
    html = html + "<button type='submit' class='btn btn-primary'>Add Task</button>";
    html = html + "</form>";
    html = html + "</div>";

    // Tasks Section
    html = html + "<div class='card tasks-section'>";
    html = html + "<h2>üìã Your Tasks</h2>";
    html = html + "<div id='task-list'>";
    html = html + "<!-- Tasks will be loaded here -->";
    html = html + "</div>";
    html = html + "</div>";

    // Footer
    html = html + "<div class='footer'>";
    html = html + "<p>Powered by RADS v0.0.3 \"Butterfly\" ü¶ã</p>";
    html = html + "<p>Pure RADS + HTML + CSS ‚Ä¢ No external JavaScript libraries</p>";
    html = html + "</div>";

    html = html + "</div>";

    // ========== INLINE JAVASCRIPT FOR DYNAMIC LOADING ==========
    html = html + "<script>";
    html = html + "fetch('/api/tasks')";
    html = html + "  .then(r => r.json())";
    html = html + "  .then(data => {";
    html = html + "    const tasks = data.tasks || [];";
    html = html + "    const container = document.getElementById('task-list');";
    html = html + "    ";
    html = html + "    // Update stats";
    html = html + "    const total = tasks.length;";
    html = html + "    const completed = tasks.filter(t => t.done === 1).length;";
    html = html + "    const pending = total - completed;";
    html = html + "    document.getElementById('total-tasks').textContent = total;";
    html = html + "    document.getElementById('completed-tasks').textContent = completed;";
    html = html + "    document.getElementById('pending-tasks').textContent = pending;";
    html = html + "    ";
    html = html + "    if (tasks.length === 0) {";
    html = html + "      container.innerHTML = '<div class=\"empty-state\"><div class=\"empty-state-icon\">üéØ</div><h3>No tasks yet!</h3><p>Add your first task above to get started.</p></div>';";
    html = html + "      return;";
    html = html + "    }";
    html = html + "    ";
    html = html + "    let html = '';";
    html = html + "    tasks.forEach(task => {";
    html = html + "      const completed = task.done === 1 ? 'completed' : '';";
    html = html + "      html += '<div class=\"task ' + completed + '\">';";
    html = html + "      html += '<div class=\"task-text\">' + task.description + '</div>';";
    html = html + "      html += '<div class=\"task-meta\">ID: ' + task.id + '</div>';";
    html = html + "      html += '<div class=\"task-actions\">';";
    html = html + "      if (task.done === 0) {";
    html = html + "        html += '<form action=\"/complete/' + task.id + '\" method=\"POST\">';";
    html = html + "        html += '<button type=\"submit\" class=\"btn btn-success\">‚úì Complete</button>';";
    html = html + "        html += '</form>';";
    html = html + "      }";
    html = html + "      html += '<form action=\"/delete/' + task.id + '\" method=\"POST\">';";
    html = html + "      html += '<button type=\"submit\" class=\"btn btn-danger\">üóë Delete</button>';";
    html = html + "      html += '</form>';";
    html = html + "      html += '</div></div>';";
    html = html + "    });";
    html = html + "    container.innerHTML = html;";
    html = html + "  });";
    html = html + "</script>";

    html = html + "</body></html>";

    return [200, html, "text/html"];
}

// API endpoint - Get all tasks as JSON
blast api_get_tasks(path, method, body, query, params, headers, cookies) {
    // Query database for all tasks
    turbo json = "{\"tasks\": [";

    // In a full implementation, we'd query the database here
    // For now, return sample data that matches our database
    json = json + "{\"id\": 1, \"description\": \"Build RADS Web Engine\", \"done\": 1},";
    json = json + "{\"id\": 2, \"description\": \"Create HTML+CSS task manager\", \"done\": 1},";
    json = json + "{\"id\": 3, \"description\": \"Deploy to localhost:5050\", \"done\": 0},";
    json = json + "{\"id\": 4, \"description\": \"Test all features\", \"done\": 0}";
    json = json + "], \"status\": \"ok\"}";

    return [200, json, "application/json"];
}

// Add new task
blast action_add_task(path, method, body, query, params, headers, cookies) {
    turbo form_data = net.form_parse(body);
    turbo description = net.form_get(form_data, "description");

    echo("‚ûï Adding task: " + description);

    // Insert into database
    db.execute("INSERT INTO tasks (description) VALUES ('" + description + "')");

    // Redirect back to home
    turbo redirect_html = "<html><head>";
    redirect_html = redirect_html + "<meta http-equiv='refresh' content='0; url=/' />";
    redirect_html = redirect_html + "</head><body>Task added! Redirecting...</body></html>";

    return [200, redirect_html, "text/html"];
}

// Complete task
blast action_complete_task(path, method, body, query, params, headers, cookies) {
    turbo id = net.param_get(params, "id");

    echo("‚úì Completing task: " + id);

    // Update database
    db.execute("UPDATE tasks SET done = 1 WHERE id = " + id);

    // Redirect back to home
    turbo redirect_html = "<html><head>";
    redirect_html = redirect_html + "<meta http-equiv='refresh' content='0; url=/' />";
    redirect_html = redirect_html + "</head><body>Task completed! Redirecting...</body></html>";

    return [200, redirect_html, "text/html"];
}

// Delete task
blast action_delete_task(path, method, body, query, params, headers, cookies) {
    turbo id = net.param_get(params, "id");

    echo("üóë Deleting task: " + id);

    // Delete from database
    db.execute("DELETE FROM tasks WHERE id = " + id);

    // Redirect back to home
    turbo redirect_html = "<html><head>";
    redirect_html = redirect_html + "<meta http-equiv='refresh' content='0; url=/' />";
    redirect_html = redirect_html + "</head><body>Task deleted! Redirecting...</body></html>";

    return [200, redirect_html, "text/html"];
}

// ============================================================================
// MAIN - START SERVER
// ============================================================================

blast main() {
    echo("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
    echo("‚ïë  ü¶ã RADS Task Manager - Pure HTML+CSS Edition            ‚ïë");
    echo("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
    echo("");

    // Initialize database
    init_database();
    echo("");

    // Create HTTP server
    echo("Starting HTTP server...");
    turbo server = net.http_server("localhost", 5050);

    // Define routes
    net.route(server, "/", page_home, "GET");
    net.route(server, "/api/tasks", api_get_tasks, "GET");
    net.route(server, "/add", action_add_task, "POST");
    net.route(server, "/complete/:id", action_complete_task, "POST");
    net.route(server, "/delete/:id", action_delete_task, "POST");

    echo("");
    echo("‚úì Server running at http://localhost:5050");
    echo("‚úì API endpoint: http://localhost:5050/api/tasks");
    echo("");
    echo("üìñ Open http://localhost:5050 in your browser!");
    echo("üõë Press Ctrl+C to stop the server");
    echo("");
    echo("Features:");
    echo("  ‚Ä¢ Pure RADS + HTML + CSS (no external libraries)");
    echo("  ‚Ä¢ Beautiful purple gradient design");
    echo("  ‚Ä¢ Animated task cards");
    echo("  ‚Ä¢ Real-time statistics");
    echo("  ‚Ä¢ SQLite database backend");
    echo("");

    // Start serving
    net.serve();
}
